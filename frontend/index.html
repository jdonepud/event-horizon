<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Horizon | Automated Triage</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
</head>

<body class="dark-theme">
    <div class="glow-container">
        <div class="glow-orb"></div>
    </div>

    <nav>
        <div class="logo">EVENT<span>HORIZON</span></div>
        <div class="status-badge">
            <span class="pulse"></span> ENGINE ONLINE
        </div>
    </nav>

    <main>
        <header>
            <h1>Vulnerability <span class="gradient-text">Triage</span></h1>
            <p>Automated Reachability & Impact Analysis Engine</p>
        </header>

        <section class="dashboard-grid">
            <!-- Stats Column -->
            <div class="card stat-card">
                <h3>System Health</h3>
                <div class="chart-placeholder">
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#222" stroke-width="10" />
                        <circle id="healthCircle" cx="50" cy="50" r="45" fill="none" stroke="var(--accent)"
                            stroke-width="10" stroke-dasharray="283" stroke-dashoffset="283" />
                    </svg>
                    <div class="stat-value" id="healthValue">0%</div>
                </div>
                <p>Coverage Depth</p>
            </div>

            <!-- Triage Control -->
            <div class="card control-card">
                <h3>Automated Ingestion</h3>
                <div class="upload-zone" id="dropZone">
                    <div class="icon">âš¡</div>
                    <p>Drop CSV or JSON reports</p>
                    <button class="btn-primary">Select Data Source</button>
                    <input type="file" id="fileInput" hidden>
                </div>
            </div>

            <!-- Analysis Log -->
            <div class="card log-card">
                <h3>Real-time Analysis</h3>
                <div class="log-entries" id="analysisLog">
                    <div class="log-entry">
                        <span class="timestamp">[16:45:02]</span>
                        <span class="msg">Awaiting ingestion...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Threat Intelligence View -->
        <section class="threat-view">
            <div class="card full-width">
                <h3>Attack Path Analysis (Vector Chaining)</h3>
                <div class="chain-viz" id="chainViz">
                    <div class="node">SSRF <div class="node-tag">CVE-2024-001</div>
                    </div>
                    <div class="connector"></div>
                    <div class="node active">SQLi <div class="node-tag">CVE-2024-002</div>
                    </div>
                    <div class="connector dashed"></div>
                    <div class="node ghost">RCE</div>
                </div>
                <div class="impact-report" id="impactReport">
                    <p><strong>Predicted Reachability:</strong> <span id="reachabilityValue">Critical Infrastructure
                            Access</span></p>
                    <p><strong>MITRE Mapping:</strong> <span id="mitreValue">T1190 (Exploit Public-Facing
                            Application)</span></p>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const analysisLog = document.getElementById('analysisLog');
            const chainViz = document.getElementById('chainViz');
            const reachabilityValue = document.getElementById('reachabilityValue');
            const mitreValue = document.getElementById('mitreValue');
            const healthValue = document.getElementById('healthValue');
            const healthCircle = document.getElementById('healthCircle');

            let totalVulns = 0;

            const addLog = (msg, type = 'info') => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const now = new Date();
                const ts = now.toTimeString().split(' ')[0];
                entry.innerHTML = `<span class="timestamp">[${ts}]</span> <span class="msg">${msg}</span>`;
                analysisLog.prepend(entry);
                if (type === 'danger') entry.style.borderLeftColor = 'var(--danger)';
                if (type === 'success') entry.style.borderLeftColor = '#00ff88';
            };

            const updateHealthChart = (newCount) => {
                totalVulns += newCount;
                // Sensitivity: 20 vulnerabilities = 100% depth for more visible changes
                const percentage = Math.min(100, Math.round((totalVulns / 20) * 100));
                const offset = 283 - (283 * (percentage / 100));

                healthValue.innerText = `${percentage}%`;
                healthCircle.style.strokeDashoffset = offset;

                if (percentage >= 100) {
                    healthCircle.style.stroke = '#00ff88';
                }
            };

            const API_URL = 'http://localhost:8000';

            const checkEngineStatus = async () => {
                try {
                    const resp = await fetch(`${API_URL}/`);
                    if (resp.ok) {
                        document.querySelector('.status-badge').innerHTML = '<span class="pulse"></span> ENGINE ONLINE';
                        addLog('Backend engine connected and ready.', 'success');
                    }
                } catch (e) {
                    document.querySelector('.status-badge').innerHTML = '<span class="pulse" style="background: var(--danger); box-shadow: 0 0 10px var(--danger);"></span> ENGINE OFFLINE';
                    addLog('Warning: Running in local simulation mode.', 'info');
                }
            };

            checkEngineStatus();

            const processData = async (file) => {
                addLog(`Ingesting ${file.name}...`, 'info');
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_URL}/ingest/csv`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error('Backend error');

                    const data = await response.json();
                    addLog(`Received analysis for ${data.summary.total_processed} vulnerabilities.`, 'success');
                    updateHealthChart(data.summary.total_processed);

                    if (data.attack_path_analysis) {
                        const pathMsg = data.summary.is_critical ? `CRITICAL: Vector Chaining: ${data.attack_path_analysis.path}` : `Path: ${data.attack_path_analysis.path}`;
                        addLog(pathMsg, data.summary.is_critical ? 'danger' : 'info');
                    }

                    updateDashboard({
                        reachability: data.individual_reports[0]?.reachability || 'Calculated Profile',
                        mitre: data.summary.is_critical ? 'T1190' : 'T1059',
                        vulns: data.summary.total_processed,
                        isCritical: data.summary.is_critical
                    });

                } catch (error) {
                    addLog(`Using local fallback for ${file.name}...`, 'info');
                    setTimeout(() => {
                        const isCritical = file.name.includes('critical');
                        const count = file.name.includes('low') ? 10 : 3;
                        updateDashboard({
                            reachability: isCritical ? 'Critical Infrastructure' : 'Isolated Network',
                            mitre: isCritical ? 'T1190' : 'T1059',
                            isCritical: isCritical
                        });
                        updateHealthChart(count);
                        addLog(`Simulation complete: ${count} vulns processed.`, 'success');
                    }, 800);
                }
            };

            const updateDashboard = (profile) => {
                reachabilityValue.innerText = profile.reachability;
                mitreValue.innerText = profile.mitre;
                const nodes = document.querySelectorAll('.node');
                nodes.forEach((node, i) => {
                    setTimeout(() => {
                        const color = profile.isCritical ? '#ff2d55' : '#007aff';
                        node.style.borderColor = color;
                        node.style.boxShadow = `0 0 20px ${color}66`;
                    }, i * 200);
                });
            };

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) processData(e.target.files[0]);
            });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
            dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = 'var(--border)'; });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                if (e.dataTransfer.files.length > 0) processData(e.dataTransfer.files[0]);
            });
        });
    </script>
</body>

</html>